name: ESPHome Compile

on:
  workflow_dispatch:
    inputs:
      encoded_yaml:
        description: Base64 编码的 ESPHome YAML 配置
        required: true
        type: string
      request_id:
        description: 用于标识此次编译请求的唯一 ID
        required: true
        type: string
      device_name:
        description: 设备名称，仅用于日志展示
        required: false
        type: string
      board:
        description: 目标板类型，仅用于日志展示
        required: false
        type: string

run-name: >-
  ESPHome compile (${{ inputs.device_name || inputs.board || 'request' }}) • ${{ inputs.request_id }}

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      REQUEST_ID: ${{ inputs.request_id }}
      DEVICE_NAME: ${{ inputs.device_name }}
      BOARD_NAME: ${{ inputs.board }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decode configuration
        id: decode
        run: |
          set -eo pipefail
          encoded="$(jq -r '.inputs.encoded_yaml' "$GITHUB_EVENT_PATH")"

          if [[ -z "$encoded" || "$encoded" == "null" ]]; then
            echo "Empty encoded YAML input" >&2
            exit 1
          fi

          echo "::add-mask::$encoded"
          printf '%s' "$encoded" | base64 --decode > config.yaml
          echo "YAML length: $(wc -c < config.yaml)"
          echo "config-path=config.yaml" >> "$GITHUB_OUTPUT"

      - name: Install ESPHome
        run: |
          python3 -m pip install --upgrade pip
          pip3 install esphome

      - name: Compile firmware
        id: compile
        run: |
          set -eo pipefail
          esphome version
          esphome compile "${{ steps.decode.outputs.config-path }}"

      - name: Prepare firmware bundle
        run: |
          set -eo pipefail
          mkdir -p artifact
          cp "${{ steps.decode.outputs.config-path }}" artifact/

          mapfile -t firmware_files < <(find .esphome/build -type f -name '*.bin')

          if [[ ${#firmware_files[@]} -eq 0 ]]; then
            echo "未找到固件 (*.bin) 文件，检查 ESPHome 编译输出" >&2
            exit 1
          fi

          for file in "${firmware_files[@]}"; do
            base="$(basename "$file")"
            cp "$file" "artifact/$base"
          done

          mapfile -t manifest_files < <(find .esphome/build -type f -name '*.manifest.json')
          for file in "${manifest_files[@]}"; do
            base="$(basename "$file")"
            cp "$file" "artifact/$base"
          done

          ls -al artifact

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.REQUEST_ID }}
          path: artifact
          retention-days: 1
          if-no-files-found: error

      - name: Publish summary
        if: always()
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ### ESPHome 编译结果

          - 请求 ID：${{ env.REQUEST_ID }}

          下载产物：在 Workflow 的 Artifacts 面板获取 `firmware-${{ env.REQUEST_ID }}`（内含 config.yaml 与 *.bin 固件）。
          EOF
