name: ESPHome Compile

on:
  workflow_dispatch:
    inputs:
      encoded_yaml:
        description: Base64 编码的 ESPHome YAML 配置
        required: true
        type: string
      request_id:
        description: 用于标识此次编译请求的唯一 ID
        required: true
        type: string
      device_name:
        description: 设备名称，仅用于日志展示
        required: false
        type: string
      board:
        description: 目标板类型，仅用于日志展示
        required: false
        type: string
      artifact_password:
        description: 下载固件压缩包所需的密码
        required: true
        type: string
      esphome_version:
        description: 需要安装的 ESPHome 版本（例如 2025.10.1），留空则使用最新版本
        required: false
        type: string

run-name: >-
  ESPHome compile (${{ inputs.device_name || inputs.board || 'request' }}) • ${{ inputs.request_id }}

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      REQUEST_ID: ${{ inputs.request_id }}
      DEVICE_NAME: ${{ inputs.device_name }}
      BOARD_NAME: ${{ inputs.board }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decode configuration
        id: decode
        run: |
          set -eo pipefail
          encoded="$(jq -r '.inputs.encoded_yaml' "$GITHUB_EVENT_PATH")"
          password="$(jq -r '.inputs.artifact_password' "$GITHUB_EVENT_PATH")"

          if [[ -z "$encoded" || "$encoded" == "null" ]]; then
            echo "Empty encoded YAML input" >&2
            exit 1
          fi

          if [[ -z "$password" || "$password" == "null" ]]; then
            echo "Missing artifact password input" >&2
            exit 1
          fi

          echo "::add-mask::$encoded"
          echo "::add-mask::$password"
          printf '%s' "$encoded" | base64 --decode > config.yaml
          echo "YAML length: $(wc -c < config.yaml)"
          echo "config-path=config.yaml" >> "$GITHUB_OUTPUT"

      - name: Install ESPHome
        run: |
          set -eo pipefail
          python3 -m pip install --upgrade pip
          version="$(jq -r '.inputs.esphome_version // ""' "$GITHUB_EVENT_PATH")"
          if [[ -n "$version" ]]; then
            echo "Installing ESPHome version $version"
            pip3 install "esphome==$version"
          else
            echo "Installing latest ESPHome"
            pip3 install esphome
          fi

      - name: Compile firmware
        id: compile
        run: |
          set -eo pipefail
          log_path="${RUNNER_TEMP}/esphome-compile.log"
          : > "$log_path"

          esphome version | tee -a "$log_path"

          set +e
          esphome compile "${{ steps.decode.outputs.config-path }}" |& tee -a "$log_path"
          status=${PIPESTATUS[0]}
          set -e

          exit "$status"

      - name: Prepare firmware bundle
        run: |
          set -eo pipefail
          password="$(jq -r '.inputs.artifact_password' "$GITHUB_EVENT_PATH")"
          if [[ -z "$password" || "$password" == "null" ]]; then
            echo "Missing artifact password input" >&2
            exit 1
          fi

          echo "::add-mask::$password"

          bundle_dir="$(mktemp -d)"
          cp "${{ steps.decode.outputs.config-path }}" "$bundle_dir/"

          mapfile -t firmware_files < <(find .esphome/build -type f -name '*.bin')

          if [[ ${#firmware_files[@]} -eq 0 ]]; then
            echo "未找到固件 (*.bin) 文件，检查 ESPHome 编译输出" >&2
            exit 1
          fi

          for file in "${firmware_files[@]}"; do
            base="$(basename "$file")"
            cp "$file" "$bundle_dir/$base"
          done

          mapfile -t manifest_files < <(find .esphome/build -type f -name '*.manifest.json')
          for file in "${manifest_files[@]}"; do
            base="$(basename "$file")"
            cp "$file" "$bundle_dir/$base"
          done

          artifact_dir="$PWD/artifact"
          mkdir -p "$artifact_dir"
          zip_name="firmware-${REQUEST_ID}-password.zip"

          (
            cd "$bundle_dir"
            zip -qr -P "$password" "$artifact_dir/$zip_name" .
          )

          rm -rf "$bundle_dir"
          rm -f "${{ steps.decode.outputs.config-path }}"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.REQUEST_ID }}
          path: artifact
          retention-days: 1
          if-no-files-found: error

      - name: Publish summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"

          cat <<'EOF' >> "$summary_file"
          ### ESPHome 编译结果

          - 请求 ID：${{ env.REQUEST_ID }}
          - 设备：${{ env.DEVICE_NAME || '未设置' }}
          - 板子：${{ env.BOARD_NAME || '未设置' }}
          - ESPHome：${{ inputs.esphome_version || '最新' }}
          - 压缩包：`artifact/firmware-${{ env.REQUEST_ID }}.zip`（下载后需使用页面展示的密码解压）

          下载产物：在 Workflow 的 Artifacts 面板获取 `firmware-${{ env.REQUEST_ID }}`。
          EOF

          if [[ '${{ steps.compile.outcome }}' == 'failure' ]]; then
            {
              echo
              echo "#### 编译错误日志（尾部）"
              echo
              if [[ -f "${RUNNER_TEMP}/esphome-compile.log" ]]; then
                echo '```'
                tail -n 30 "${RUNNER_TEMP}/esphome-compile.log"
                echo '```'
              else
                echo "（未找到编译日志）"
              fi
            } >> "$summary_file"
          fi
