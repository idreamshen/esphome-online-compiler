* ESPHome 在线编译平台

Vue 3 前端 + Cloudflare Pages Functions + GitHub Actions：用户通过 GitHub OAuth 授权后，直接在浏览器中提交 ESPHome YAML，即可触发 Workflow 编译并下载固件，无需手填 Personal Access Token。

* 目录结构
  - `frontend/`：Vite + Vue 3 单页应用，负责 OAuth 登录、YAML 输入、状态轮询与固件下载；
  - `functions/`：Cloudflare Pages Functions（`[[path]].ts`）实现 GitHub OAuth、Session 管理与 Actions API 代理；
  - `.github/workflows/esphome-compile.yml`：实际执行编译的 GitHub Actions Workflow；
  - `.dev.vars.example`：本地开发时可复制为 `.dev.vars`，提供所需环境变量示例；
  - `wrangler.toml`：Pages 项目基本配置（无敏感信息）。

* 准备 GitHub OAuth App
  1. 访问 [[https://github.com/settings/developers][GitHub Settings → Developer settings → OAuth Apps]] 创建新的 OAuth App；
  2. Homepage / Callback URL 建议设置为将来 Cloudflare Pages 的域名，例如：
     - Homepage：`https://your-project.pages.dev/`
     - Authorization callback URL：`https://your-project.pages.dev/auth/callback`
  3. 记录 `Client ID`，并点击「Generate a new client secret」保存 `Client Secret`；
  4. Pages Functions 会请求 `repo` + `workflow` scope，以便在 public 仓库中触发 `workflow_dispatch`。

* Cloudflare Pages 配置
  1. 在 Cloudflare 控制台创建 Pages 项目（选择连接 Git 仓库或手动上传）；
  2. 构建设置建议：
     - Build Command：`npm install && npm run build --prefix frontend`
     - Build Output Directory：`frontend/dist`
     - Functions Directory（自动识别）：`functions`
  3. 在 Pages → Settings → Environment variables 中添加以下变量（生产和 Preview 环境都需配置）：
     - `GITHUB_CLIENT_ID`
     - `GITHUB_CLIENT_SECRET`
     - `SESSION_SECRET`（随机 32+ 字节字符串，可用 `openssl rand -base64 32` 生成）
     - `GITHUB_OAUTH_REDIRECT_URI`（与 OAuth App callback 保持一致；生产填 Pages 域名如 `https://your-project.pages.dev/auth/callback`；开发时请使用前端调试域名例如 `http://localhost:5173/auth/callback`，确保 Cookie 域名一致）
     - `GITHUB_REPO_OWNER`
     - `GITHUB_REPO_NAME`
     - `GITHUB_WORKFLOW_ID`（如 `esphome-compile.yml`）
     - `GITHUB_WORKFLOW_REF`（默认 `main`）
     - `FRONTEND_URL`（生产环境可写 Pages 域名，方便授权回跳）
     - `ALLOWED_ORIGINS`（逗号分隔允许跨域的前端地址，至少包含 Pages 域名；本地开发可加 `http://localhost:5173`）
     - `GITHUB_REQUIRE_PRIVATE_REPO`（默认为空/false，仅当需要访问私有仓库时设为 `true`，将 OAuth scope 提升为 `repo`）

* 本地开发
  1. 安装依赖并运行前端：
     #+begin_src shell
     cd frontend
     npm install
     npm run dev
     #+end_src
  2. 在仓库根目录复制 `.dev.vars.example` 为 `.dev.vars`，填入测试所需的 OAuth 配置；
  3. 另开终端，启动 Pages Functions 本地环境（Cloudflare CLI）：
     #+begin_src shell
     # 首次需要安装 CLI：npm install -g wrangler
     wrangler pages dev frontend/dist --local --port 8787
     # 若 dist 目录不存在，可先执行一次 npm run build --prefix frontend
     #+end_src
  4. 浏览器访问 `http://localhost:5173`，前端会通过 Vite 代理把 `/auth/*`、`/api/*` 请求转发到 `http://127.0.0.1:8787` 的 Pages Functions。

* 使用流程
  1. 点击「GitHub 登录」进入官方授权页，同意 `repo` 与 `workflow` 权限；
  2. 回到页面后填写 ESPHome YAML，可选输入设备名称、板子类型；
  3. 提交后系统会将 YAML Base64 编码，通过 Pages Functions 触发 `workflow_dispatch`；
  4. 前端定时轮询 Workflow 状态，完成后显示可下载的固件产物；
  5. 如需切换账户或重新授权，使用「退出登录」按钮清除会话。

* GitHub Actions Workflow
  - 解码 YAML 到 `config.yaml`；
  - 安装最新 ESPHome，执行 `esphome compile config.yaml`；
  - 将所有生成的固件 `*.bin`（及对应 manifest）与原始 `config.yaml` 打包到 `artifact/`，上传为 `firmware-<request_id>` Artifact（保留 14 天）；
  - 运行名称包含 `request_id`，Pages Functions 根据该字段匹配 Workflow Run。

* 安全注意
  - OAuth Access Token 通过签名后的 HttpOnly Cookie 保存，仅 Pages Functions 可访问；
  - 切勿将真实密钥写入仓库，线上变量通过 Cloudflare 控制台配置，开发时使用 `.dev.vars`（已在 `.gitignore`）；
  - 如需回收授权，可在 GitHub → Settings → Applications 中撤销对应 OAuth App。

* 可选增强
  - 集成 Monaco / CodeMirror 提供 YAML 高亮、校验；
  - 增加常用板型模板与示例库；
  - 展示历史运行记录、多产物选择；
  - 长耗时编译的通知或进度提示。
